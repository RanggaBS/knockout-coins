-- -------------------------------------------------------------------------- --
-- SWinEff.lua                                                                --
-- -------------------------------------------------------------------------- --

local EAWGIA = _G.EffectAddWindowGlowInArea

-- stylua: ignore start
-- area, x1, y1, z1, x2, y2, z2, x3, y3, z3, x4, y4, z4, length, ?, angle, ?, ?, ?
EAWGIA(18, -414.636, 378.864, 86.509, -414.636, 376.765, 86.509, -414.636, 376.765, 85.253, -414.636, 378.864, 85.253, 4, 2, 65.65, true, true, 0)
EAWGIA(18, -414.636, 376.609, 86.509, -414.636, 374.548, 86.509, -414.636, 374.548, 85.253, -414.636, 376.609, 85.253, 4, 2, 65.65, true, true, 0)
EAWGIA(18, -414.636, 369.77, 86.509, -414.636, 367.683, 86.509, -414.636, 367.683, 85.253, -414.636, 369.77, 85.253, 4, 2, 65.65, true, true, 0)
EAWGIA(18, -414.636, 367.447, 86.509, -414.636, 365.413, 86.509, -414.636, 365.413, 85.253, -414.636, 367.447, 85.253, 4, 2, 65.65, true, true, 0)
EAWGIA(18, -429.159, 365.413, 86.507, -429.159, 367.447, 86.507, -429.159, 367.447, 85.249, -429.159, 365.413, 85.249, 4, 2, 65.65, true, true, 0)
EAWGIA(18, -429.159, 367.683, 86.507, -429.159, 369.77, 86.507, -429.159, 369.77, 85.249, -429.159, 367.683, 85.249, 4, 2, 65.65, true, true, 0)
EAWGIA(18, -429.159, 374.548, 86.507, -429.159, 376.609, 86.507, -429.159, 376.609, 85.249, -429.159, 374.548, 85.249, 4, 2, 65.65, true, true, 0)
EAWGIA(18, -429.159, 376.765, 86.507, -429.159, 378.864, 86.507, -429.159, 378.864, 85.249, -429.159, 376.765, 85.249, 4, 2, 65.65, true, true, 0)
EAWGIA(17, -527.413, 395.26, 17.715, -527.413, 394.032, 17.715, -527.413, 394.032, 15.458, -527.413, 395.26, 15.458, 3, 2, 65.65, true, true, 0)
EAWGIA(17, -527.413, 391.748, 17.715, -527.413, 390.521, 17.715, -527.413, 390.521, 15.458, -527.413, 391.748, 15.458, 3, 2, 65.65, true, true, 0)
EAWGIA(17, -526.281, 389.28, 17.715, -525.054, 389.28, 17.715, -525.054, 389.28, 15.458, -526.281, 389.28, 15.458, 3, 2, 65.65, true, true, 0)
EAWGIA(8, -765.237, -126.953, 20.872, -764.088, -128.103, 20.872, -763.609, -127.856, 20.241, -765.014, -126.452, 20.241, 19.75, 3, 45.65, true, true, 0)
EAWGIA(8, -763.986, -142.333, 20.883, -765.135, -143.482, 20.883, -764.916, -143.941, 20.252, -763.517, -142.542, 20.252, 19.75, 3, 45.65, true, true, 0)
EAWGIA(8, -779.222, -143.188, 20.883, -780.369, -142.042, 20.883, -780.865, -142.253, 20.252, -779.465, -143.653, 20.252, 19.75, 3, 45.65, true, true, 0)
EAWGIA(8, -780.312, -128.065, 20.87, -779.165, -126.918, 20.87, -779.413, -126.41, 20.239, -780.818, -127.815, 20.239, 19.75, 3, 45.65, true, true, 0)
EAWGIA(27, -701.141, 367.219, 301.971, -703.506, 367.219, 301.971, -703.506, 367.219, 299.951, -701.141, 367.219, 299.951, 6.75, 1.3, 60.65, true, true, 0)
EAWGIA(27, -703.572, 367.219, 301.971, -705.925, 367.219, 301.971, -705.925, 367.219, 299.951, -703.572, 367.219, 299.951, 6.75, 1.3, 60.65, true, true, 0)
EAWGIA(27, -705.987, 367.219, 301.971, -708.38, 367.219, 301.971, -708.381, 367.219, 299.951, -705.987, 367.219, 299.951, 6.75, 1.3, 60.65, true, true, 0)
EAWGIA(27, -709.828, 367.219, 301.971, -712.2, 367.219, 301.971, -712.2, 367.219, 299.951, -709.828, 367.219, 299.951, 6.75, 1.3, 60.65, true, true, 0)
EAWGIA(27, -712.262, 367.219, 301.971, -714.61, 367.219, 301.971, -714.61, 367.219, 299.951, -712.262, 367.219, 299.951, 6.75, 1.3, 60.65, true, true, 0)
EAWGIA(27, -714.675, 367.219, 301.971, -717.068, 367.219, 301.971, -717.068, 367.219, 299.951, -714.675, 367.219, 299.951, 6.75, 1.3, 60.65, true, true, 0)
EAWGIA(27, -701.141, 367.219, 297.691, -703.506, 367.219, 297.691, -703.506, 367.219, 295.755, -701.141, 367.219, 295.755, 5.75, 1.3, 60.65, true, true, 0)
EAWGIA(27, -703.572, 367.219, 297.691, -705.925, 367.219, 297.691, -705.925, 367.219, 295.755, -703.572, 367.219, 295.755, 5.75, 1.3, 60.65, true, true, 0)
EAWGIA(27, -705.987, 367.219, 297.691, -708.38, 367.219, 297.691, -708.381, 367.219, 295.755, -705.987, 367.219, 295.755, 5.75, 1.3, 60.65, true, true, 0)
EAWGIA(27, -709.828, 367.219, 297.691, -712.2, 367.219, 297.691, -712.2, 367.219, 295.755, -709.828, 367.219, 295.755, 5.75, 1.3, 60.65, true, true, 0)
EAWGIA(27, -712.262, 367.219, 297.691, -714.61, 367.219, 297.691, -714.61, 367.219, 295.755, -712.262, 367.219, 295.755, 5.75, 1.3, 60.65, true, true, 0)
EAWGIA(27, -714.675, 367.219, 297.691, -717.068, 367.219, 297.691, -717.068, 367.219, 295.755, -714.675, 367.219, 295.755, 5.75, 1.3, 60.65, true, true, 0)
EAWGIA(27, -729.35, 367.216, 301.971, -731.868, 367.216, 301.971, -731.868, 367.216, 299.951, -729.35, 367.216, 299.951, 5.75, 1.3, 60.65, true, true, 0)
EAWGIA(27, -731.934, 367.216, 301.971, -734.494, 367.216, 301.971, -734.494, 367.216, 299.951, -731.934, 367.216, 299.951, 5.75, 1.3, 60.65, true, true, 0)
EAWGIA(6, -700.53, 324.5, 36.35, -700.53, 323.82, 36.35, -700.53, 323.82, 34.65, -700.53, 324.5, 34.65, 3, 2, 60.65, true, true, 0)
EAWGIA(6, -700.53, 323, 36.35, -700.53, 322.3, 36.35, -700.53, 322.3, 34.65, -700.53, 323, 34.65, 3, 2, 60.65, true, true, 0)
EAWGIA(6, -700.53, 321.5, 36.35, -700.53, 320.8, 36.35, -700.53, 320.8, 34.65, -700.53, 321.5, 34.65, 3, 2, 60.65, true, true, 0)
EAWGIA(6, -700.53, 315.73, 36.35, -700.53, 315, 36.35, -700.53, 315, 34.65, -700.53, 315.73, 34.65, 3, 2, 60.65, true, true, 0)
EAWGIA(6, -700.53, 314.23, 36.35, -700.53, 313.5, 36.35, -700.53, 313.5, 34.65, -700.53, 314.23, 34.65, 3, 2, 60.65, true, true, 0)
EAWGIA(6, -700.53, 312.73, 36.35, -700.53, 312, 36.35, -700.53, 312, 34.65, -700.53, 312.73, 34.65, 3, 2, 60.65, true, true, 0)
EAWGIA(14, -508.673, 330.525, 34.356, -507.278, 330.525, 34.356, -507.278, 330.525, 32.355, -508.673, 330.525, 32.355, 4, 2, 45.65, true, true, 0)
EAWGIA(14, -503.439, 330.525, 34.356, -502.044, 330.525, 34.356, -502.044, 330.525, 32.355, -503.439, 330.525, 32.355, 4, 2, 45.65, true, true, 0)
EAWGIA(14, -497.422, 330.525, 34.356, -496.012, 330.525, 34.356, -496.012, 330.525, 32.355, -497.422, 330.525, 32.355, 4, 2, 45.65, true, true, 0)
EAWGIA(14, -491.555, 307.391, 34.326, -492.937, 307.391, 34.326, -492.937, 307.391, 32.364, -491.555, 307.391, 32.364, 4, 3, 25.65, true, true, 0)
EAWGIA(14, -495.967, 307.373, 34.326, -497.349, 307.373, 34.326, -497.349, 307.373, 32.364, -495.967, 307.373, 32.364, 4, 3, 25.65, true, true, 0)
EAWGIA(2, -622.153, -270.662, 3.509, -622.153, -271.734, 3.509, -622.153, -271.734, 0.982, -622.153, -270.662, 0.982, 6, 2, 60.65, true, true, 0)
EAWGIA(2, -622.153, -272.784, 3.509, -622.153, -273.856, 3.509, -622.153, -273.856, 0.982, -622.153, -272.784, 0.982, 6, 2, 60.65, true, true, 0)
EAWGIA(2, -622.153, -282.197, 3.509, -622.153, -283.27, 3.509, -622.153, -283.27, 0.982, -622.153, -282.197, 0.982, 6, 2, 60.65, true, true, 0)
EAWGIA(2, -622.153, -284.191, 3.509, -622.153, -285.263, 3.509, -622.153, -285.263, 0.982, -622.153, -284.191, 0.982, 6, 2, 60.65, true, true, 0)
EAWGIA(15, -554.97, 328.73, 1.27, -554.97, 327.54, 1.27, -554.97, 327.54, -0.91, -554.97, 328.73, -0.91, 3, 1.5, 60.65, true, true, 0)
EAWGIA(15, -554.97, 327.48, 1.27, -554.97, 326.14, 1.27, -554.97, 326.14, -0.91, -554.97, 327.48, -0.91, 3, 1.5, 60.65, true, true, 0)
EAWGIA(15, -554.97, 326.09, 1.27, -554.97, 324.79, 1.27, -554.97, 324.79, -0.91, -554.97, 326.09, -0.91, 3, 1.5, 60.65, true, true, 0)
EAWGIA(15, -554.97, 319.7, 1.27, -554.97, 318.44, 1.27, -554.97, 318.44, -0.91, -554.97, 319.7, -0.91, 3, 1.5, 60.65, true, true, 0)
EAWGIA(15, -554.97, 318.37, 1.27, -554.97, 317.12, 1.27, -554.97, 317.12, -0.91, -554.97, 318.37, -0.91, 3, 1.5, 60.65, true, true, 0)
EAWGIA(15, -554.97, 317.06, 1.27, -554.97, 315.75, 1.27, -554.97, 315.75, -0.91, -554.97, 317.06, -0.91, 3, 1.5, 60.65, true, true, 0)
EAWGIA(35, -406.997, 311.113, 5.662, -406.993, 308.967, 5.664, -406.997, 308.969, 3.344, -407.001, 311.113, 3.344, 0, 1.5, 60.65, true, true, 0)
EAWGIA(35, -462.28, 308.877, 5.662, -462.284, 311.023, 5.664, -462.279, 311.022, 3.344, -462.276, 308.877, 3.344, 0, 1.5, 60.65, true, true, 0)
EAWGIA(35, -457.232, 324.83, 5.737, -455.086, 324.835, 5.74, -455.088, 324.83, 3.419, -457.232, 324.827, 3.419, 0, 1.5, 60.65, true, false, 0)
EAWGIA(35, -435.45, 323.602, 4.938, -433.892, 323.605, 4.94, -433.893, 323.602, 3.255, -435.45, 323.599, 3.255, 0, 1.5, 60.65, true, false, 0)
EAWGIA(35, -414.281, 324.865, 5.7, -412.135, 324.869, 5.702, -412.136, 324.865, 3.382, -414.281, 324.861, 3.382, 0, 1.5, 60.65, true, false, 0)
EAWGIA(35, -412.068, 294.72, 5.7, -414.214, 294.725, 5.698, -414.214, 294.728, 3.379, -412.069, 294.725, 3.379, 5, 1.5, 45.65, true, true, 0)
EAWGIA(35, -433.892, 295.797, 4.938, -435.45, 295.8, 4.94, -435.45, 295.802, 3.255, -433.893, 295.8, 3.255, 5, 1.5, 45.65, true, true, 0)
EAWGIA(35, -455.086, 294.567, 5.737, -457.232, 294.571, 5.737, -457.232, 294.574, 3.419, -455.088, 294.571, 3.419, 5, 1.5, 45.65, true, true, 0)
EAWGIA(35, -446.855, 296.273, 0.439, -448.184, 296.273, 0.439, -448.184, 296.273, -1.539, -446.855, 296.273, -1.539, 15, 2.5, 65.65, true, true, 0)
EAWGIA(35, -453.131, 296.273, 0.439, -454.46, 296.273, 0.439, -454.46, 296.273, -1.539, -453.131, 296.273, -1.539, 12, 1.5, 65.65, true, true, 0)
EAWGIA(35, -458.621, 300.635, 0.464, -458.621, 302.124, 0.464, -458.621, 302.124, -1.515, -458.621, 300.635, -1.515, 0, 1.5, 65.65, true, false, 0)
EAWGIA(35, -458.634, 305.285, 0.464, -458.621, 306.754, 0.464, -458.621, 306.754, -1.515, -458.621, 305.285, -1.515, 0, 1.5, 65.65, true, false, 0)
EAWGIA(35, -427.937, 299.074, 0.411, -429.319, 299.074, 0.411, -429.319, 299.074, -1.566, -427.937, 299.074, -1.566, 5, 1.5, 35.65, true, true, 0)
EAWGIA(35, -413.894, 299.036, 0.458, -415.276, 299.036, 0.458, -415.276, 299.036, -1.539, -413.894, 299.036, -1.539, 4, 1.5, 35.65, true, true, 0)
EAWGIA(35, -418.891, 299.036, 0.458, -420.273, 299.036, 0.458, -420.273, 299.036, -1.539, -418.891, 299.036, -1.539, 4, 1.5, 35.65, true, true, 0)
EAWGIA(35, -415.391, 323.213, 0.437, -414.01, 323.213, 0.437, -414.01, 323.213, -1.539, -415.391, 323.213, -1.539, 0, 1.5, 35.65, true, false, 0)
EAWGIA(35, -420.389, 323.213, 0.437, -419.007, 323.213, 0.437, -419.007, 323.213, -1.539, -420.389, 323.213, -1.539, 0, 1.5, 35.65, true, false, 0)
EAWGIA(35, -425.648, 323.213, 0.437, -424.266, 323.213, 0.437, -424.266, 323.213, -1.539, -425.648, 323.213, -1.539, 0, 1.5, 35.65, true, false, 0)
EAWGIA(35, -430.645, 323.213, 0.437, -429.263, 323.213, 0.437, -429.263, 323.213, -1.539, -430.645, 323.213, -1.539, 0, 1.5, 35.65, true, false, 0)
EAWGIA(35, -435.857, 323.213, 0.437, -434.476, 323.213, 0.437, -434.476, 323.213, -1.539, -435.857, 323.213, -1.539, 0, 1.5, 35.65, true, false, 0)
EAWGIA(35, -440.854, 323.213, 0.437, -439.473, 323.213, 0.437, -439.473, 323.213, -1.539, -440.854, 323.213, -1.539, 0, 1.5, 35.65, true, false, 0)
EAWGIA(35, -446.249, 323.213, 0.437, -444.868, 323.213, 0.437, -444.868, 323.213, -1.539, -446.249, 323.213, -1.539, 0, 1.5, 35.65, true, false, 0)
EAWGIA(35, -451.246, 323.213, 0.437, -449.865, 323.213, 0.437, -449.865, 323.213, -1.539, -451.246, 323.213, -1.539, 0, 1.5, 35.65, true, false, 0)
EAWGIA(35, -456.721, 320.301, -4.974, -455.338, 320.301, -4.974, -455.338, 320.301, -6.799, -456.721, 320.301, -6.799, 0, 1.5, 35.65, true, false, 0)
EAWGIA(35, -450.459, 320.301, -4.974, -449.077, 320.301, -4.974, -449.077, 320.301, -6.799, -450.459, 320.301, -6.799, 0, 1.5, 35.65, true, false, 0)
EAWGIA(35, -444.37, 320.301, -4.974, -442.989, 320.301, -4.974, -442.989, 320.301, -6.799, -444.37, 320.301, -6.799, 0, 1.5, 35.65, true, false, 0)
EAWGIA(35, -433.643, 323.151, -4.977, -432.261, 323.151, -4.977, -432.261, 323.151, -6.961, -433.643, 323.151, -6.961, 0, 1.5, 35.65, true, false, 0)
EAWGIA(35, -429.233, 323.151, -4.977, -427.85, 323.151, -4.977, -427.85, 323.151, -6.961, -429.233, 323.151, -6.961, 0, 1.5, 35.65, true, false, 0)
EAWGIA(35, -417.813, 298.975, -4.982, -419.194, 298.975, -4.982, -419.194, 298.975, -6.961, -417.813, 298.975, -6.961, 4, 1.5, 35.65, true, true, 0)
EAWGIA(35, -422.81, 298.975, -4.982, -424.191, 298.975, -4.982, -424.191, 298.975, -6.961, -422.81, 298.975, -6.961, 4, 1.5, 35.65, true, true, 0)
EAWGIA(35, -427.806, 298.975, -4.982, -429.187, 298.975, -4.982, -429.187, 298.975, -6.961, -427.806, 298.975, -6.961, 4, 1.5, 35.65, true, true, 0)
EAWGIA(35, -432.803, 298.975, -4.982, -434.184, 298.975, -4.982, -434.184, 298.975, -6.961, -432.803, 298.975, -6.961, 4, 1.5, 35.65, true, true, 0)
EAWGIA(35, -438.267, 299.108, -4.724, -439.649, 299.108, -4.724, -439.649, 299.108, -6.706, -438.267, 299.108, -6.706, 4, 1.5, 35.65, true, true, 0)
EAWGIA(35, -411.596, 311.755, 0.702, -411.596, 310.373, 0.702, -411.596, 310.373, -1.28, -411.596, 311.755, -1.28, 0, 1.5, 35.65, true, false, 0)
EAWGIA(35, -459.216, 310.502, 0.702, -459.216, 311.884, 0.702, -459.216, 311.884, -1.28, -459.216, 310.502, -1.28, 0, 1.5, 35.65, true, false, 0)
EAWGIA(9, -788.242, 183.146, 97.092, -788.242, 184.772, 97.092, -788.242, 184.772, 92.862, -788.242, 183.122, 92.862, 6.75, 2, 65.65, true, true, 0)
EAWGIA(9, -788.242, 189.662, 97.092, -788.242, 191.288, 97.092, -788.242, 191.288, 92.862, -788.242, 189.638, 92.862, 6.75, 2, 65.65, true, true, 0)
EAWGIA(9, -788.242, 195.853, 97.092, -788.242, 197.479, 97.092, -788.242, 197.479, 92.862, -788.242, 195.829, 92.862, 6.75, 2, 65.65, true, true, 0)
EAWGIA(9, -788.242, 209.115, 97.092, -788.242, 210.741, 97.092, -788.242, 210.741, 92.862, -788.242, 209.091, 92.862, 6.75, 2, 65.65, true, true, 0)
EAWGIA(9, -788.242, 215.011, 97.092, -788.242, 216.637, 97.092, -788.242, 216.637, 92.862, -788.242, 214.987, 92.862, 6.75, 2, 65.65, true, true, 0)
EAWGIA(9, -788.242, 221.822, 97.092, -788.242, 223.448, 97.092, -788.242, 223.448, 92.862, -788.242, 221.798, 92.862, 6.75, 2, 65.65, true, true, 0)
EAWGIA(9, -764.795, 179.678, 97.092, -766.421, 179.678, 97.092, -766.421, 179.678, 92.862, -764.771, 179.678, 92.862, 0, 2.5, 45.65, true, true, 0)
EAWGIA(9, -777.873, 179.678, 97.092, -779.499, 179.678, 97.092, -779.499, 179.678, 92.862, -777.849, 179.678, 92.862, 0, 2.5, 45.65, true, true, 0)
EAWGIA(9, -779.499, 226.558, 97.092, -777.873, 226.558, 97.092, -777.873, 226.558, 92.862, -779.523, 226.558, 92.862, 0, 2.5, 45.65, true, true, 0)
EAWGIA(9, -766.417, 226.558, 97.092, -764.791, 226.558, 97.092, -764.791, 226.558, 92.862, -766.441, 226.558, 92.862, 0, 2.5, 45.65, true, true, 0)
EAWGIA(9, -765.217, 179.818, 99.857, -766.02, 179.818, 99.857, -766.02, 179.818, 98.929, -765.204, 179.818, 98.929, 0, 2.5, 45.65, true, true, 0)
EAWGIA(9, -778.309, 179.818, 99.857, -779.111, 179.818, 99.857, -779.111, 179.818, 98.929, -778.296, 179.818, 98.929, 0, 2.5, 45.65, true, true, 0)
EAWGIA(9, -788.102, 183.548, 99.857, -788.102, 184.35, 99.857, -788.102, 184.35, 98.929, -788.102, 183.535, 98.929, 0, 2.5, 45.65, true, true, 0)
EAWGIA(9, -788.102, 190.064, 99.857, -788.102, 190.866, 99.857, -788.102, 190.866, 98.929, -788.102, 190.05, 98.929, 0, 2.5, 45.65, true, true, 0)
EAWGIA(9, -788.102, 196.255, 99.857, -788.102, 197.057, 99.857, -788.102, 197.057, 98.929, -788.102, 196.241, 98.929, 0, 2.5, 45.65, true, true, 0)
EAWGIA(9, -788.102, 209.517, 99.857, -788.102, 210.319, 99.857, -788.102, 210.319, 98.929, -788.102, 209.503, 98.929, 0, 2.5, 45.65, true, true, 0)
EAWGIA(9, -788.102, 215.413, 99.857, -788.102, 216.215, 99.857, -788.102, 216.215, 98.929, -788.102, 215.399, 98.929, 0, 2.5, 45.65, true, true, 0)
EAWGIA(9, -788.102, 222.224, 99.857, -788.102, 223.026, 99.857, -788.102, 223.026, 98.929, -788.102, 222.21, 98.929, 0, 2.5, 45.65, true, true, 0)
EAWGIA(9, -779.097, 226.418, 99.857, -778.295, 226.418, 99.857, -778.295, 226.418, 98.929, -779.111, 226.418, 98.929, 0, 2.5, 45.65, true, true, 0)
EAWGIA(9, -766.016, 226.418, 99.857, -765.213, 226.418, 99.857, -765.213, 226.418, 98.929, -766.029, 226.418, 98.929, 0, 2.5, 45.65, true, true, 0)
EAWGIA(5, -697.39, 199.6, 34.82, -699.27, 199.6, 34.82, -699.27, 199.6, 32.3, -697.39, 199.6, 32.3, 3, 2, 45.65, true, true, 0)
EAWGIA(5, -703.29, 199.6, 34.82, -705.17, 199.6, 34.82, -705.17, 199.6, 32.3, -703.29, 199.6, 32.3, 3, 2, 45.65, true, true, 0)
EAWGIA(13, -683.994, -74.739, 65.903, -683.994, -72.773, 65.903, -683.994, -72.773, 62.27, -683.994, -74.739, 62.27, 10, 2.5, 45.65, true, true, 0)
EAWGIA(13, -683.994, -67.865, 65.903, -683.994, -65.899, 65.903, -683.994, -65.899, 62.27, -683.994, -67.865, 62.27, 10, 2.5, 45.65, true, true, 0)
EAWGIA(13, -683.994, -60.606, 65.903, -683.994, -58.64, 65.903, -683.994, -58.64, 62.27, -683.994, -60.606, 62.27, 10, 2.5, 45.65, true, true, 0)
EAWGIA(13, -683.994, -53.399, 65.903, -683.994, -51.433, 65.903, -683.994, -51.433, 62.27, -683.994, -53.399, 62.27, 10, 2.5, 45.65, true, true, 0)
EAWGIA(13, -683.994, -46.497, 65.903, -683.994, -44.531, 65.903, -683.994, -44.531, 62.27, -683.994, -46.497, 62.27, 10, 2.5, 45.65, true, true, 0)
EAWGIA(13, -654.308, -53.669, 68.235, -654.308, -54.82, 68.235, -654.308, -54.82, 67.014, -654.308, -53.669, 67.014, 0, 2, 45.65, true, true, 0)
EAWGIA(13, -654.308, -57.387, 68.235, -654.308, -58.538, 68.235, -654.308, -58.538, 67.014, -654.308, -57.387, 67.014, 0, 2, 45.65, true, true, 0)
EAWGIA(13, -654.308, -60.651, 68.235, -654.308, -61.803, 68.235, -654.308, -61.803, 67.014, -654.308, -60.651, 67.014, 0, 2, 45.65, true, true, 0)
EAWGIA(13, -654.308, -64.421, 68.235, -654.308, -65.572, 68.235, -654.308, -65.572, 67.014, -654.308, -64.421, 67.014, 0, 2, 45.65, true, true, 0)
EAWGIA(13, -654.383, -57.387, 62.517, -654.383, -58.538, 62.517, -654.383, -58.538, 61.296, -654.383, -57.387, 61.296, 0, 2, 45.65, true, true, 0)
EAWGIA(13, -654.383, -60.651, 62.517, -654.383, -61.802, 62.517, -654.383, -61.802, 61.296, -654.383, -60.651, 61.296, 0, 2, 45.65, true, true, 0)
EAWGIA(13, -637.682, -71.662, 68.48, -637.682, -70.511, 68.48, -637.682, -70.511, 67.259, -637.682, -71.662, 67.259, 12, 2.25, 35.65, true, true, 0)
EAWGIA(13, -637.682, -67.074, 68.48, -637.682, -65.923, 68.48, -637.682, -65.923, 67.259, -637.682, -67.074, 67.259, 12, 2.25, 35.65, true, true, 0)
EAWGIA(13, -637.682, -62.582, 68.48, -637.682, -61.43, 68.48, -637.682, -61.43, 67.259, -637.682, -62.582, 67.259, 12, 2.25, 35.65, true, true, 0)
EAWGIA(13, -637.682, -57.829, 68.48, -637.682, -56.678, 68.48, -637.682, -56.678, 67.259, -637.682, -57.829, 67.259, 12, 2.25, 35.65, true, true, 0)
EAWGIA(13, -637.682, -53.24, 68.48, -637.682, -52.089, 68.48, -637.682, -52.089, 67.259, -637.682, -53.24, 67.259, 12, 2.25, 35.65, true, true, 0)
EAWGIA(13, -637.682, -48.748, 68.48, -637.682, -47.597, 68.48, -637.682, -47.597, 67.259, -637.682, -48.748, 67.259, 12, 2.25, 35.65, true, true, 0)
EAWGIA(32, -559.904, 129.922, 55.05, -561.53, 130.49, 55.044, -561.53, 130.49, 51.421, -559.904, 129.922, 51.421, 0, 2, 45.65, true, true, 0)
EAWGIA(32, -561.748, 130.662, 55.044, -562.75, 132.161, 55.044, -562.75, 132.161, 51.427, -561.748, 130.662, 51.427, 0, 2, 45.65, true, true, 0)
EAWGIA(32, -562.834, 132.44, 55.044, -562.834, 134.293, 55.044, -562.834, 134.293, 51.427, -562.834, 132.44, 51.427, 15, 1.65, 25.65, true, true, 0)
EAWGIA(32, -562.75, 134.571, 55.044, -561.748, 136.071, 55.044, -561.748, 136.071, 51.427, -562.75, 134.571, 51.427, 0, 2, 45.65, true, true, 0)
EAWGIA(32, -561.53, 136.243, 55.044, -559.904, 136.819, 55.044, -559.904, 136.819, 51.426, -561.53, 136.243, 51.426, 0, 2, 45.65, true, true, 0)
EAWGIA(32, -548.178, 128.89, 61.024, -550.473, 129.629, 61.018, -550.473, 129.629, 55.874, -548.178, 128.89, 55.874, 0, 2, 45.65, true, true, 0)
EAWGIA(32, -550.78, 129.852, 61.018, -552.195, 131.8, 61.018, -552.195, 131.8, 55.879, -550.78, 129.852, 55.879, 0, 2, 45.65, true, true, 0)
EAWGIA(32, -552.313, 132.132, 61.018, -552.313, 134.551, 61.018, -552.313, 134.569, 55.879, -552.313, 132.107, 55.879, 0, 2, 45.65, true, true, 0)
EAWGIA(32, -552.195, 134.931, 61.018, -550.78, 136.878, 61.018, -550.78, 136.878, 55.879, -552.195, 134.931, 55.879, 0, 2, 45.65, true, true, 0)
EAWGIA(32, -550.473, 137.102, 61.018, -548.178, 137.85, 61.018, -548.178, 137.85, 55.879, -550.473, 137.102, 55.879, 0, 2, 45.65, true, true, 0)
EAWGIA(32, -548.19, 128.919, 62.982, -550.468, 129.66, 62.982, -550.566, 129.525, 61.374, -548.185, 128.759, 61.374, 5, 2, 45.65, true, true, 0)
EAWGIA(32, -550.765, 129.923, 62.982, -552.173, 131.86, 62.982, -552.331, 131.809, 61.367, -550.863, 129.789, 61.367, 7, 2, 45.65, true, true, 0)
EAWGIA(32, -552.261, 132.168, 62.982, -552.261, 134.563, 62.982, -552.419, 134.614, 61.367, -552.419, 132.116, 61.367, 7, 3, 80.65, true, true, 0)
EAWGIA(32, -552.173, 134.89, 62.982, -550.765, 136.828, 62.982, -550.863, 136.962, 61.367, -552.331, 134.941, 61.367, 7, 2, 45.65, true, true, 0)
EAWGIA(32, -550.445, 137.06, 62.982, -548.166, 137.8, 62.982, -548.161, 137.969, 61.367, -550.542, 137.194, 61.367, 5, 2, 45.65, true, true, 0)
EAWGIA(32, -548.193, 130.482, 65.328, -549.534, 130.918, 65.328, -550.404, 129.72, 63.29, -548.193, 129.001, 63.29, 5, 2, 45.65, true, true, 0)
EAWGIA(32, -549.835, 131.207, 65.328, -550.664, 132.348, 65.328, -552.072, 131.891, 63.29, -550.705, 130.009, 63.29, 5, 2, 45.65, true, true, 0)
EAWGIA(32, -550.753, 132.66, 65.328, -550.753, 134.07, 65.328, -552.162, 134.528, 63.29, -552.162, 132.202, 63.29, 13, 3, 5.65, true, true, 0)
EAWGIA(32, -550.664, 134.402, 65.328, -549.835, 135.543, 65.328, -550.705, 136.741, 63.29, -552.072, 134.86, 63.29, 5, 2, 45.65, true, true, 0)
EAWGIA(32, -549.51, 135.811, 65.328, -548.169, 136.247, 65.328, -548.169, 137.727, 63.29, -550.381, 137.009, 63.29, 5, 2, 45.65, true, true, 0)
EAWGIA(32, -540.703, 128.873, 62.982, -544.069, 128.873, 62.982, -544.069, 128.71, 61.367, -540.703, 128.707, 61.367, 0, 2, 45.65, true, true, 0)
EAWGIA(32, -544.369, 128.873, 62.982, -547.843, 128.873, 62.982, -547.838, 128.71, 61.367, -544.369, 128.707, 61.367, 0, 2, 45.65, true, true, 0)
EAWGIA(32, -540.703, 130.437, 65.33, -544.069, 130.437, 65.33, -544.069, 128.953, 63.288, -540.703, 128.953, 63.288, 0, 2, 45.65, true, true, 0)
EAWGIA(32, -544.369, 130.437, 65.33, -547.843, 130.437, 65.33, -547.843, 128.953, 63.288, -544.369, 128.953, 63.288, 0, 2, 45.65, true, true, 0)
EAWGIA(32, -547.843, 136.292, 65.33, -544.369, 136.292, 65.33, -544.369, 137.776, 63.288, -547.843, 137.776, 63.288, 0, 2, 45.65, true, true, 0)
EAWGIA(32, -544.069, 136.292, 65.33, -540.703, 136.292, 65.33, -540.703, 137.776, 63.288, -544.069, 137.776, 63.288, 0, 2, 45.65, true, true, 0)
EAWGIA(32, -547.843, 137.847, 62.982, -544.369, 137.847, 62.982, -544.369, 138.014, 61.374, -547.843, 138.016, 61.374, 0, 2, 45.65, true, true, 0)
EAWGIA(32, -544.069, 137.847, 62.982, -540.703, 137.847, 62.982, -540.703, 138.014, 61.374, -544.069, 138.016, 61.374, 0, 2, 45.65, true, true, 0)
EAWGIA(2, -635.97, -293.01, 17.59, -633.99, -293.01, 17.59, -633.99, -293.01, 12.25, -635.97, -293.01, 12.25, 5, 0.75, 60.65, true, true, 0)
EAWGIA(2, -632.8, -293.01, 17.59, -630.82, -293.01, 17.59, -630.82, -293.01, 12.25, -632.8, -293.01, 12.25, 5, 0.75, 60.65, true, true, 0)
EAWGIA(2, -629.63, -293.01, 17.59, -627.65, -293.01, 17.59, -627.65, -293.01, 12.25, -629.63, -293.01, 12.25, 5, 0.75, 60.65, true, true, 0)
EAWGIA(2, -626.46, -293.01, 17.59, -624.48, -293.01, 17.59, -624.48, -293.01, 12.25, -626.46, -293.01, 12.25, 5, 0.75, 60.65, true, true, 0)
EAWGIA(2, -623.3, -293.01, 17.59, -621.31, -293.01, 17.59, -621.31, -293.01, 12.25, -623.3, -293.01, 12.25, 5, 0.75, 60.65, true, true, 0)
EAWGIA(2, -617.66, -324.74, 14.32, -618.61, -324.74, 14.32, -618.61, -324.74, 11.92, -617.66, -324.74, 11.92, 3, 2, 45.65, true, true, 0)
EAWGIA(2, -617.63, -324.74, 8.82, -618.59, -324.74, 8.82, -618.59, -324.74, 6.42, -617.63, -324.74, 6.42, 3, 2, 45.65, true, true, 0)
EAWGIA(2, -617.62, -324.74, 3.78, -618.59, -324.74, 3.78, -618.59, -324.74, 0.91, -617.62, -324.74, 0.91, 3, 2, 45.65, true, true, 0)
EAWGIA(2, -638.73, -324.74, 14.32, -639.68, -324.74, 14.32, -639.68, -324.74, 11.92, -638.73, -324.74, 11.92, 3, 2, 45.65, true, true, 0)
EAWGIA(2, -638.7, -324.74, 8.82, -639.66, -324.74, 8.82, -639.66, -324.74, 6.42, -638.7, -324.74, 6.42, 3, 2, 45.65, true, true, 0)
EAWGIA(2, -638.7, -324.74, 3.78, -639.66, -324.74, 3.78, -639.66, -324.74, 0.91, -638.7, -324.74, 0.91, 3, 2, 45.65, true, true, 0)
EAWGIA(2, -624.97, -324.7, 16.04, -627.06, -324.7, 16.04, -627.09, -324.7, 8.25, -624.97, -324.7, 8.25, 20, 2, 45.65, true, true, 0)
EAWGIA(2, -627.59, -324.7, 17.18, -629.69, -324.7, 17.18, -629.69, -324.7, 8.25, -627.59, -324.7, 8.25, 20, 2, 45.65, true, true, 0)
EAWGIA(2, -630.22, -324.7, 16.04, -632.32, -324.7, 16.04, -632.31, -324.7, 8.25, -630.2, -324.7, 8.25, 20, 2, 45.65, true, true, 0)
EAWGIA(2, -627.094, -328.332, 4.346, -627.905, -328.332, 4.346, -627.905, -328.332, 3.169, -627.094, -328.332, 3.169, 6, 2, 60.65, true, true, 0)
EAWGIA(2, -628.087, -328.332, 5.371, -629.187, -328.332, 5.371, -629.187, -328.332, 3.169, -628.087, -328.332, 3.169, 6, 2, 60.65, true, true, 0)
EAWGIA(2, -629.389, -328.332, 4.347, -630.2, -328.332, 4.347, -630.2, -328.332, 3.169, -629.389, -328.332, 3.169, 6, 2, 60.65, true, true, 0)
EAWGIA(2, -582.468, -306.961, 3.479, -582.468, -307.919, 3.479, -582.468, -307.919, 1.073, -582.468, -306.961, 1.073, 0, 2, 60.65, true, true, 0)
EAWGIA(2, -582.469, -319.343, 3.479, -582.469, -320.301, 3.479, -582.469, -320.301, 1.073, -582.469, -319.343, 1.073, 0, 2, 60.65, true, true, 0)
EAWGIA(2, -581.768, -308.137, 9.44, -581.768, -309.098, 9.44, -581.768, -309.098, 6.57, -581.768, -308.137, 6.57, 0, 2, 60.65, true, true, 0)
EAWGIA(2, -581.77, -319.198, 9.44, -581.77, -320.159, 9.44, -581.77, -320.159, 6.57, -581.77, -319.198, 6.57, 0, 2, 60.65, true, true, 0)
EAWGIA(2, -674.814, -310.079, 3.49, -674.814, -309.122, 3.49, -674.814, -309.122, 1.084, -674.814, -310.079, 1.084, 0, 2, 60.65, true, true, 0)
EAWGIA(2, -674.738, -306.265, 3.49, -674.738, -305.307, 3.49, -674.738, -305.307, 1.084, -674.738, -306.265, 1.084, 0, 2, 60.65, true, true, 0)
EAWGIA(2, -674.81, -310.039, 9.445, -674.81, -309.078, 9.445, -674.81, -309.078, 6.57, -674.81, -310.039, 6.57, 0, 2, 60.65, true, true, 0)
EAWGIA(2, -674.806, -306.263, 9.445, -674.806, -305.302, 9.445, -674.806, -305.302, 6.57, -674.806, -306.263, 6.57, 0, 2, 60.65, true, true, 0)
EAWGIA(23, -642.66, 220.35, 2.41, -644.06, 220.35, 2.41, -644.06, 220.35, 0.43, -642.66, 220.35, 0.43, 3.75, 2, 45.65, true, true, 0)
EAWGIA(23, -645.8, 220.35, 2.41, -647.19, 220.35, 2.41, -647.19, 220.35, 0.43, -645.8, 220.35, 0.43, 3.75, 2, 45.65, true, true, 0)
EAWGIA(23, -651.51, 220.35, 2.41, -652.9, 220.35, 2.41, -652.9, 220.35, 0.43, -651.51, 220.35, 0.43, 3.75, 2, 45.65, true, true, 0)
EAWGIA(23, -654.64, 220.35, 2.41, -656.03, 220.35, 2.41, -656.03, 220.35, 0.43, -654.64, 220.35, 0.43, 3.75, 2, 45.65, true, true, 0)
EAWGIA(39, -652.107, 120.811, 5.207, -654.064, 120.811, 5.207, -654.064, 120.811, 3.878, -652.107, 120.811, 3.878, 0, 1, 45.65, true, true, 0)
EAWGIA(39, -656.686, 120.811, 5.207, -658.542, 120.811, 5.207, -658.542, 120.811, 3.878, -656.686, 120.811, 3.878, 0, 1, 45.65, true, true, 0)
-- stylua: ignore end

EAWGIA = nil --[[@diagnostic disable-line]]

-- -------------------------------------------------------------------------- --
-- Knockout Coins                                                             --
-- -------------------------------------------------------------------------- --

-- -------------------------------------------------------------------------- --
-- File: init.lua
-- -------------------------------------------------------------------------- --
-- -------------------------------------------------------------------------- --
-- Mod root global variable                                                   --
-- -------------------------------------------------------------------------- --

_G.KNOCKOUT_COINS = {
  API = {},
  Enum = {},
  Class = {},
  Instance = {},
  Util = {},
  Thread = {},
  DefaultSettings = {},

  -- Bully AE user configurations, `nil` by default
  ---@type table<string, boolean|number|string>?
  Config = nil,

  ConfigData = {
    SE = {
      path = 'config/',
      file = 'config_se.ini',
    },
    AE = {
      path = '/storage/emulated/0/Games/BullyAE/Mods/KnockoutCoins/config/',
      file = 'config_ae.lur',
    },
  },
  AE_isConfigLoaded = false,
  AE_isWarningMessageDisplayed = true,
}

-- -------------------------------------------------------------------------- --
-- Load scripts                                                               --
-- -------------------------------------------------------------------------- --

local isBullySE = type(_G.ClassMusicSetPlayers) == 'function'
  and type(_G.PlayerGetUsingTouchScreen) ~= 'function'

if isBullySE then
  local files = {
    { name = 'Util', dir = 'utils/' },
    { name = '_group', dir = 'enums/' },

    { name = 'BaseSource', dir = 'core/config/source/' },
    { name = 'IniSource', dir = 'core/config/source/' },
    { name = 'LuaSource', dir = 'core/config/source/' },
    { name = 'Config', dir = 'core/config/' },

    { name = 'ObjectEntity', dir = 'core/objects/' },
    { name = 'PickupSpeech', dir = 'core/objects/pickup/' },
    { name = 'BasePickup', dir = 'core/objects/pickup/' },
    { name = 'CoinPickup', dir = 'core/objects/pickup/' },
    { name = 'PickupManager', dir = 'core/objects/pickup/' },

    { name = 'Coin', dir = 'core/coins/' },
    { name = 'CoinDropManager', dir = 'core/coins/' },

    { name = 'PedKnockedOut', dir = 'core/threads/' },
    { name = 'ThreadManager', dir = 'core/threads/' },

    { name = 'EventManager', dir = 'core/' },
    { name = 'KnockoutCoins', dir = 'core/' },
  }
  for _, file in ipairs(files) do
    LoadScript(file.dir .. file.name .. '.lua')
  end
end

-- -------------------------------------------------------------------------- --
-- Default Settings                                                           --
-- -------------------------------------------------------------------------- --

KNOCKOUT_COINS.DefaultSettings = {
  -- [Coin Values]
  -- ------------------------------------------------------------------------ --
  -- Defines how much money each coin gives when collected.
  -- The game uses "cents" internally. (100 = $1.00)
  -- Example:
  --   25  = +$0.25
  --   100 = +$1.00
  -- ------------------------------------------------------------------------ --
  CoinPenny = 25, -- small gold coin (common)
  CoinDollar = 100, -- large silver coin (rare)

  -- [Coin Settings]
  -- ---------------------------------------------------------------------------- --
  -- Controls how coins behave after a ped is knocked out.
  -- ---------------------------------------------------------------------------- --

  -- Base chance (in percent) for *any* coin to drop.
  -- Individual coin chances are multiplied by this value.
  GlobalDropChance = 75,

  -- How close the player must be to automatically pick up a coin.
  PickupRadius = 1.25,

  -- Determines how long coins stay in the world before disappearing.
  --   0 = Time-based (coins vanish after `LifetimeSeconds`)
  --   1 = Ped-based (coins stay until the KO'd ped fades out)
  --   2 = Hybrid (stay while ped exists, then a short timer starts)
  LifetimeMode = 2,

  -- Duration (in seconds) coins remain if `LifetimeMode` = 0 or 2.
  LifetimeSeconds = 30,

  -- [Coin Type Chance]
  -- ---------------------------------------------------------------------------- --
  -- Defines individual drop chances for each coin type (percent).
  -- These chances are evaluated only if `GlobalDropChance` is passed.
  -- Example:
  --   CoinPennyChance = 80  -> 80% chance if a drop occurs
  --   CoinDollarChance = 20 -> 20% chance if a drop occurs
  -- ---------------------------------------------------------------------------- --
  CoinPennyChance = 80,
  CoinDollarChance = 20,

  -- [Coin Animation]
  -- ---------------------------------------------------------------------------- --
  -- Controls the visual animation and motion of dropped coins.
  -- ---------------------------------------------------------------------------- --

  -- Determines how high the coin bobs up and down.
  -- Default: 1
  BobAmplitude = 1,

  -- Determines how fast the coin bobs up and down.
  -- Higher values make it oscillate faster.
  -- Default: 3
  BobFrequency = 3,

  -- Determines how fast the coin spins in degrees per second.
  -- Default: 60
  RotationSpeed = 60,

  -- If true, each coin will spin in a random direction (clockwise or counterclockwise).
  -- If false, all coins spin the same direction.
  -- Default: true
  RandomRotationDirection = true,

  -- If true, all coins bob in sync (move up and down together).
  -- If false, each coin has a random phase offset.
  -- Default: false
  BobSync = false,

  -- [Faction Drop Amount]
  -- ---------------------------------------------------------------------------- --
  -- Defines how many coins each faction may drop when knocked out.
  -- The final number can be randomized between Min and Max.
  -- Example: NerdMin = 1, NerdMax = 3 → drop 1–3 coins randomly.
  -- ---------------------------------------------------------------------------- --

  PrefectMin = 1,
  PrefectMax = 2,

  NerdMin = 1,
  NerdMax = 2,

  JockMin = 1,
  JockMax = 2,

  DropoutMin = 1,
  DropoutMax = 2,

  GreaserMin = 1,
  GreaserMax = 2,

  PreppyMin = 2,
  PreppyMax = 4,

  StudentMin = 1,
  StudentMax = 2,

  CopMin = 1,
  CopMax = 3,

  TeacherMin = 1,
  TeacherMax = 3,

  TownpersonMin = 1,
  TownpersonMax = 3,

  ShopkeepMin = 1,
  ShopkeepMax = 4,

  BullyMin = 1,
  BullyMax = 2,
}

-- -------------------------------------------------------------------------- --
-- File: utils/Util.lua
-- -------------------------------------------------------------------------- --
-- -------------------------------------------------------------------------- --
-- Utility / Helper Functions                                                 --
-- -------------------------------------------------------------------------- --

local Util = {
  gameEdition = nil, ---@type 'AE'|'SE'|'PS2
  isBullyAE = nil, ---@type boolean
}

-- -------------------------------------------------------------------------- --
-- Methods                                                                    --
-- -------------------------------------------------------------------------- --

---@return 'AE'|'SE'|'PS2
function Util.GetGameEdition()
  if Util.gameEdition == nil then
    Util.gameEdition = type(_G.PlayerGetUsingTouchScreen) == 'function' and 'AE'
      or type(_G.ClassMusicSetPlayers) == 'function' and 'SE'
      or 'PS2'
  end
  return Util.gameEdition
end

---@param path string
---@param fileName string
---@param required? boolean
---@return boolean loaded
function Util.AELoadScript(path, fileName, required)
  local chunk, errorMessage = loadfile(path .. fileName)
  if not chunk then
    if required then
      while true do
        Wait(0)
        MinigameSetAnnouncement('Cannot read or missing\n' .. fileName, true)
      end
    end
    return false
  end
  chunk()
  return true
end

---@return fun(): integer
function Util.AllPeds()
  if Util.GetGameEdition() == 'SE' then return AllPeds end

  local peds = { PedFindInAreaXYZ(0, 0, 0, 99999) }
  local index = 0
  local count = table.getn(peds)

  return function()
    index = index + 1
    while index <= count do
      local ped = peds[index]
      if PedIsValid(ped) then return ped end
      index = index + 1
    end --[[@diagnostic disable-line]]
  end
end

---@param n number
---@param mult? number # default `1`
---@return number
function Util.RoundToMultiple(n, mult)
  mult = mult or 1
  return math.floor((n + mult / 2) / mult) * mult
end

---@param v number
---@param min number
---@param max number
---@return number
function Util.Clamp(v, min, max)
  return v < min and min or v > max and max or v
end

---@param cents number
---@return string
function Util.CentsToString(cents)
  local dollars = cents / 100
  return string.format('+$%.2f', dollars)
end

---@param chance number
---@return boolean
function Util.PercentChance(chance)
  return (math.random() * 100) <= chance
end

---@param dividend number
---@param divisor number
---@return number
function Util.Modulus(dividend, divisor)
  return dividend - divisor * math.floor(dividend / divisor)
end

---@param word string
---@return string
function Util.CapitalizeFirstLetter(word)
  return string.upper(string.sub(word, 1, 1)) .. string.sub(word, 2, -1)
end

---@param factionId integer
---@return string|'Unknown'
function Util.GetFactionName(factionId)
  local names = {
    [0] = 'Prefect',
    [1] = 'Nerd',
    [2] = 'Jock',
    [3] = 'Dropout',
    [4] = 'Greaser',
    [5] = 'Preppy',
    [6] = 'Student',
    [7] = 'Cop',
    [8] = 'Teacher',
    [9] = 'Townperson',
    [10] = 'Shopkeep',
    [11] = 'Bully',
  }
  return names[factionId] or 'Unknown'
end

---@param a number
---@param b number
---@param t number
---@return number
function Util.Lerp(a, b, t)
  return a == b and a or t == 0 and a or t == 1 and b or a + (b - a) * t
end

---@param x1 number
---@param y1 number
---@param z1 number
---@param x2 number
---@param y2 number
---@param z2 number
---@param factor number
---@return number x, number y, number z
function Util.LerpBetweenCoords3d(x1, y1, z1, x2, y2, z2, factor)
  local x = Util.Lerp(x1, x2, factor)
  local y = Util.Lerp(y1, y2, factor)
  local z = Util.Lerp(z1, z2, factor)
  return x, y, z
end

---@param min number
---@param max number
---@return number
function Util.RandomFloatInclusive(min, max)
  return min + (math.random() * (max - min))
end

---@param ped integer
---@return integer|-1
function Util.GetPedModelId(ped)
  for id = 0, 258 do
    if PedIsModel(ped, id) then return id end
  end
  return -1
end

---@param ped integer
---@return boolean
function Util.IsPedHumanoid(ped)
  for _, id in ipairs({ -- non-human models
    136, -- rat
    141, -- pitbull
    219, -- pitbull 2
    220, -- pitbull 3
    233, -- punching bag
  }) do
    if PedIsModel(ped, id) or Util.GetPedModelId(ped) == id then
      return false
    end
  end
  return true
end

-- function Util.PlayPickupMoneyVoiceForJimmy() end

-- -------------------------------------------------------------------------- --
-- Export                                                                     --
-- -------------------------------------------------------------------------- --

KNOCKOUT_COINS.Util = Util

-- -------------------------------------------------------------------------- --
-- File: enums/Event.lua
-- -------------------------------------------------------------------------- --
-- -------------------------------------------------------------------------- --
-- Event Enumeration                                                          --
-- -------------------------------------------------------------------------- --

---@enum EEvent
local Event = {
  AllCoinsCleared = 'AllCoinsCleared',
  CoinBatchSpawned = 'CoinBatchSpawned',
  CoinCollected = 'CoinCollected',
  CoinDropFailed = 'CoinDropFailed',
  CoinExpired = 'CoinExpired',
  CoinRemoved = 'CoinRemoved',
  CoinSpawned = 'CoinSpawned',
  PedKnockedOut = 'PedKnockedOut',

  BeforeCoinUpdate = 'BeforeCoinUpdate',
  AfterCoinUpdate = 'AfterCoinUpdate',

  BeforeCoinUpdateAll = 'BeforeCoinUpdateAll',
  AfterCoinUpdateAll = 'AfterCoinUpdateAll',
}

-- -------------------------------------------------------------------------- --
-- Export                                                                     --
-- -------------------------------------------------------------------------- --

KNOCKOUT_COINS.Enum.Event = Event

-- -------------------------------------------------------------------------- --
-- File: enums/_group.lua
-- -------------------------------------------------------------------------- --
local Util = KNOCKOUT_COINS.Util;

(function()
  if Util.GetGameEdition() ~= 'SE' then return end

  local filenames = { 'Event' }
  for _, filename in ipairs(filenames) do
    LoadScript('enums/' .. filename .. '.lua')
  end
end)()

-- -------------------------------------------------------------------------- --
-- File: core/config/source/BaseSource.lua
-- -------------------------------------------------------------------------- --
-- -------------------------------------------------------------------------- --
-- BaseSource Class                                                           --
-- -------------------------------------------------------------------------- --

---@class BaseSource
---@field path string
---@field filename string
local BaseSource = {}
BaseSource.__index = BaseSource

-- -------------------------------------------------------------------------- --
-- Constructor                                                                --
-- -------------------------------------------------------------------------- --

---@param path string
---@param filename string
---@return BaseSource
function BaseSource.new(path, filename)
  local instance = setmetatable({}, BaseSource)
  instance.path = path
  instance.filename = filename
  return instance
end

-- -------------------------------------------------------------------------- --
-- Methods                                                                    --
-- -------------------------------------------------------------------------- --

-- Abstract: Load config data
function BaseSource:Load()
  -- Nothing. Must be implemented by subclass.
end

-- Abstract: Get config value
function BaseSource:Get(key, defaultValue)
  -- Nothing. Must be implemented by subclass.
end

-- -------------------------------------------------------------------------- --
-- Export                                                                     --
-- -------------------------------------------------------------------------- --

KNOCKOUT_COINS.Class.BaseSource = BaseSource

-- -------------------------------------------------------------------------- --
-- File: core/config/source/IniSource.lua
-- -------------------------------------------------------------------------- --
-- -------------------------------------------------------------------------- --
-- Import                                                                     --
-- -------------------------------------------------------------------------- --

local BaseSource = KNOCKOUT_COINS.Class.BaseSource

-- -------------------------------------------------------------------------- --
-- IniSource Class                                                            --
-- -------------------------------------------------------------------------- --

---@class IniSource : BaseSource
---@field path string
---@field filename string
---@field object userdata
local IniSource = setmetatable({}, { __index = BaseSource })
IniSource.__index = IniSource

-- -------------------------------------------------------------------------- --
-- Constructor                                                                --
-- -------------------------------------------------------------------------- --

---@param path string
---@param filename string
---@return IniSource
function IniSource.new(path, filename)
  local instance = BaseSource.new(path, filename)
  instance = setmetatable(instance, IniSource)
  return instance --[[@as IniSource]]
end

-- -------------------------------------------------------------------------- --
-- Methods                                                                    --
-- -------------------------------------------------------------------------- --

function IniSource:Load()
  local fullPath = self.path .. self.filename
  local object = LoadConfigFile(fullPath)
  if IsConfigMissing(object) then
    return error('Cannot load ini: ' .. fullPath)
  end
  self.object = object
end

---@param key string
---@param defaultValue Config_Value
function IniSource:Get(key, defaultValue)
  local getter = ({
    ['boolean'] = GetConfigBoolean,
    ['number'] = GetConfigNumber,
    ['string'] = GetConfigString,
  })[type(defaultValue)] or GetConfigValue
  return getter(self.object, key, defaultValue) or defaultValue
end

-- -------------------------------------------------------------------------- --
-- Export                                                                     --
-- -------------------------------------------------------------------------- --

KNOCKOUT_COINS.Class.IniSource = IniSource

-- -------------------------------------------------------------------------- --
-- File: core/config/source/LuaSource.lua
-- -------------------------------------------------------------------------- --
-- -------------------------------------------------------------------------- --
-- Import                                                                     --
-- -------------------------------------------------------------------------- --

local Util = KNOCKOUT_COINS.Util
local BaseSource = KNOCKOUT_COINS.Class.BaseSource

-- -------------------------------------------------------------------------- --
-- LuaSource Class                                                            --
-- -------------------------------------------------------------------------- --

---@class LuaSource : BaseSource
---@field path string
---@field filename string
---@field data table<string, Config_Value>
local LuaSource = setmetatable({}, { __index = BaseSource })
LuaSource.__index = LuaSource

-- -------------------------------------------------------------------------- --
-- Constructor                                                                --
-- -------------------------------------------------------------------------- --

---@param path string
---@param filename string
---@param data table<string, Config_Value>
---@return LuaSource
function LuaSource.new(path, filename, data)
  local instance = BaseSource.new(path, filename)
  instance = setmetatable(instance, LuaSource)

  instance.data = data

  return instance --[[@as LuaSource]]
end

-- -------------------------------------------------------------------------- --
-- Methods                                                                    --
-- -------------------------------------------------------------------------- --

function LuaSource:Load()
  if Util.GetGameEdition() ~= 'AE' then return end

  local ok = Util.AELoadScript(self.path, self.filename)
  if ok then
    KNOCKOUT_COINS.AE_isConfigLoaded = true
    KNOCKOUT_COINS.AE_isWarningMessageDisplayed = false
    return
  end

  SoundPlay2D('Erand')
  MinigameSetAnnouncement('Knockout Coins WARNING', true)
  MinigameHoldCompletion()
  Wait(2000)

  MinigameSetAnnouncement('Failed to load config\n' .. self.filename, true)
  MinigameHoldCompletion()
  Wait(2000)

  MinigameSetAnnouncement('Using default configuration\n', true)
  MinigameHoldCompletion()
  Wait(2000)

  MinigameReleaseCompletion()
  KNOCKOUT_COINS.AE_isWarningMessageDisplayed = false
end

---@param key string
---@param defaultValue Config_Value
---@return Config_Value
function LuaSource:Get(key, defaultValue)
  local value = self.data[key]
  if value == nil or type(value) ~= type(defaultValue) then
    return defaultValue
  end
  return value
end

-- -------------------------------------------------------------------------- --
-- Export                                                                     --
-- -------------------------------------------------------------------------- --

KNOCKOUT_COINS.Class.LuaSource = LuaSource

-- -------------------------------------------------------------------------- --
-- File: core/config/Config.lua
-- -------------------------------------------------------------------------- --
-- -------------------------------------------------------------------------- --
-- Config Class                                                               --
-- -------------------------------------------------------------------------- --

---@class Config
---@field object userdata?
---@field defaultSettings table<string, Config_Value>
---@field settings table<string, Config_Value>
---@field configSource IniSource|LuaSource
local Config = {}
Config.__index = Config

-- -------------------------------------------------------------------------- --
-- Constructor                                                                --
-- -------------------------------------------------------------------------- --

---@param defaultSettings table<string, Config_Value>
---@param configSource IniSource|LuaSource
---@return Config
function Config.new(defaultSettings, configSource)
  local instance = setmetatable({}, Config)

  instance.defaultSettings = defaultSettings
  instance.settings = {}
  instance.configSource = configSource

  instance:Load()

  return instance
end

-- -------------------------------------------------------------------------- --
-- Methods                                                                    --
-- -------------------------------------------------------------------------- --

function Config:Load()
  self.configSource:Load()

  for key, defaultValue in pairs(self.defaultSettings) do
    self.settings[key] = self.configSource:Get(key, defaultValue)
  end
end

---@param key string
---@param fallbackValue? Config_Value
---@return Config_Value
function Config:Get(key, fallbackValue)
  return self.settings[key] or fallbackValue or self.defaultSettings[key]
end

-- -------------------------------------------------------------------------- --
-- Export                                                                     --
-- -------------------------------------------------------------------------- --

KNOCKOUT_COINS.Class.Config = Config

-- -------------------------------------------------------------------------- --
-- Types                                                                      --
-- -------------------------------------------------------------------------- --

---@alias Config_Value boolean|number|string

-- -------------------------------------------------------------------------- --
-- File: core/objects/ObjectEntity.lua
-- -------------------------------------------------------------------------- --
-- -------------------------------------------------------------------------- --
-- ObjectEntity class                                                         --
-- -------------------------------------------------------------------------- --

---@class ObjectEntity
---@field name string
---@field index integer
---@field pool integer
---@field pos ArrayOfNumbers3D
---@field area integer
---@field rotation number
local ObjectEntity = {}
ObjectEntity.__index = ObjectEntity

---Create a new persistent entity in the world.
---@param name string
---@param x? number
---@param y? number
---@param z? number
---@param area? integer
---@param rotation? number
function ObjectEntity.new(name, x, y, z, area, rotation)
  local self = setmetatable({}, ObjectEntity)

  self.name = name
  self.pos = { x or 0, y or 0, z or 0 }
  self.area = area or AreaGetVisible()
  self.rotation = rotation or 0

  self.index, self.pool = CreatePersistentEntity(
    name,
    self.pos[1],
    self.pos[2],
    self.pos[3],
    self.area,
    self.rotation
  )

  return self
end

---Internal helper to recreate the entity.
---@return ObjectEntity
function ObjectEntity:Recreate()
  -- Delete the old one
  if self.index and self.pool then
    DeletePersistentEntity(self.index, self.pool)
  end
  -- Recreate
  self.index, self.pool = CreatePersistentEntity(
    self.name,
    self.pos[1],
    self.pos[2],
    self.pos[3],
    self.rotation,
    self.area
  )
  return self
end

---Set a new rotation (in degrees)
---@param deg? number
---@return ObjectEntity
function ObjectEntity:SetRotation(deg)
  if self.rotation == deg then return self end
  self.rotation = deg or self.rotation
  return self:Recreate()
end

---Set a new position (x, y, z)
---@param x? number
---@param y? number
---@param z? number
---@return ObjectEntity
function ObjectEntity:SetPosition(x, y, z)
  if self.pos[1] == x and self.pos[2] == y and self.pos[3] == z then
    return self
  end
  self.pos[1] = x or self.pos[1]
  self.pos[2] = y or self.pos[2]
  self.pos[3] = z or self.pos[3]
  return self:Recreate()
end

---Destroy this entity from the world
---@return boolean success
function ObjectEntity:Destroy()
  if not self.index or not self.pool then return false end
  DeletePersistentEntity(self.index, self.pool)
  self.index, self.pool = nil, nil
  return true
end

---Check if this entity still exists in the world
---@return boolean
function ObjectEntity:IsExist()
  return self.index ~= nil and self.pool ~= nil
end

---@return string
function ObjectEntity:GetName()
  return self.name
end

---@return number x, number y, number z
function ObjectEntity:GetPosition()
  return self.pos[1], self.pos[2], self.pos[3]
end

---@return integer
function ObjectEntity:GetArea()
  return self.area
end

---@return number
function ObjectEntity:GetRotation()
  return self.rotation
end

---@return integer index, integer pool
function ObjectEntity:GetIndexAndPool()
  return self.index, self.pool
end

-- -------------------------------------------------------------------------- --
-- Export                                                                     --
-- -------------------------------------------------------------------------- --

KNOCKOUT_COINS.Class.ObjectEntity = ObjectEntity

-- -------------------------------------------------------------------------- --
-- File: core/objects/pickup/PickupSpeech.lua
-- -------------------------------------------------------------------------- --
-- -------------------------------------------------------------------------- --
-- PickupSpeech Class                                                         --
-- -------------------------------------------------------------------------- --

---@class PickupSpeech
---@field private _lastPlayTime number
---@field private _cooldown number
local PickupSpeech = {
  _lastPlayTime = 0,
  _cooldown = 3000, -- in milliseconds
}

-- -------------------------------------------------------------------------- --
-- Static Methods                                                             --
-- -------------------------------------------------------------------------- --

---@return boolean
function PickupSpeech.CanPlaySpeech()
  local JIMMY_MODEL_ID = 0
  if not PedIsModel(gPlayer, JIMMY_MODEL_ID) then return false end

  local self = PickupSpeech

  local now = GetTimer()
  if now - self._lastPlayTime < self._cooldown then return false end
  self._lastPlayTime = now

  return true
end

---@param speechName string
function PickupSpeech.Play(speechName)
  local self = PickupSpeech
  if not self.CanPlaySpeech() then return end
  if SoundSpeechPlaying(gPlayer) then SoundStopCurrentSpeechEvent(gPlayer) end
  SoundPlayAmbientSpeechEvent(gPlayer, speechName)
end

function PickupSpeech.PlayMoney()
  local self = PickupSpeech
  self.Play('PLAYER_GET_MONEY')
end

-- -------------------------------------------------------------------------- --
-- Export                                                                     --
-- -------------------------------------------------------------------------- --

KNOCKOUT_COINS.Class.PickupSpeech = PickupSpeech

-- -------------------------------------------------------------------------- --
-- File: core/objects/pickup/BasePickup.lua
-- -------------------------------------------------------------------------- --
-- -------------------------------------------------------------------------- --
-- BasePickup Class                                                           --
-- -------------------------------------------------------------------------- --

---@class BasePickup
---@field type string
---@field entity ObjectEntity
---@field radius number
---@field isCollected boolean
---@field lifetime number # in milliseconds
---@field lifetimeMode 0|1|2
---@field spawnTime number
---@field koTime number
---@field ped integer?
local BasePickup = {}
BasePickup.__index = BasePickup

-- -------------------------------------------------------------------------- --
-- Constructor                                                                --
-- -------------------------------------------------------------------------- --

---@param entity ObjectEntity
---@param radius? number
---@param lifetime? number
---@param ped? integer
---@return BasePickup
function BasePickup.new(entity, radius, lifetime, ped)
  local instance = setmetatable({}, BasePickup)
  instance.entity = entity
  instance.radius = radius or 1.0
  instance.isCollected = false
  instance.lifetime = lifetime or (30 * 1000)
  instance.lifetimeMode = 0 -- default: time-based
  instance.spawnTime = GetTimer()
  instance.koTime = nil
  instance.ped = ped
  return instance
end

-- -------------------------------------------------------------------------- --
-- Methods                                                                    --
-- -------------------------------------------------------------------------- --

function BasePickup:OnPickup()
  -- Override in subclass
end

function BasePickup:Update()
  -- Override in subclass
end

---@return string
function BasePickup:GetType()
  return self.type
end

---@return boolean
function BasePickup:IsCollected()
  return self.isCollected
end

---@param set boolean
function BasePickup:SetCollected(set)
  self.isCollected = set
end

---@return boolean
function BasePickup:IsExist()
  return self.entity:IsExist()
end

---@return ObjectEntity
function BasePickup:GetEntity()
  return self.entity
end

---@param entity ObjectEntity
function BasePickup:SetEntity(entity)
  self.entity = entity
end

---@return number x, number y, number z
function BasePickup:GetPosition()
  return self.entity:GetPosition()
end

---@return number
function BasePickup:GetRadius()
  return self.radius
end

---@return boolean success
function BasePickup:Destroy()
  return self.entity:Destroy()
end

---@return Pickup_LifetimeModeEnum
function BasePickup:GetLifetimeMode()
  return self.lifetimeMode
end

---@param mode Pickup_LifetimeModeEnum
function BasePickup:SetLifetimeMode(mode)
  self.lifetimeMode = mode
end

---@return number
function BasePickup:GetLifetime()
  return self.lifetime
end

---@param lifetime number
function BasePickup:SetLifetime(lifetime)
  self.lifetime = lifetime
end

---@return number
function BasePickup:GetSpawnTime()
  return self.spawnTime
end

---@return number
function BasePickup:GetAge()
  return GetTimer() - self.spawnTime
end

---@return integer?
function BasePickup:GetPed()
  return self.ped
end

---@param ped integer?
function BasePickup:SetPed(ped)
  self.ped = ped
end

---@return number?
function BasePickup:GetKOTime()
  return self.koTime
end

---@param time number
function BasePickup:SetKOTime(time)
  self.koTime = time
end

-- -------------------------------------------------------------------------- --
-- Export                                                                     --
-- -------------------------------------------------------------------------- --

KNOCKOUT_COINS.Class.BasePickup = BasePickup

-- -------------------------------------------------------------------------- --
-- Types                                                                      --
-- -------------------------------------------------------------------------- --

---@alias Pickup_LifetimeMode 'time-based'|'ped-based'|'hybrid'
---@alias Pickup_LifetimeModeEnum 0|1|2

-- -------------------------------------------------------------------------- --
-- File: core/objects/pickup/CoinPickup.lua
-- -------------------------------------------------------------------------- --
-- -------------------------------------------------------------------------- --
-- Import                                                                     --
-- -------------------------------------------------------------------------- --

local Default = KNOCKOUT_COINS.DefaultSettings
local Util = KNOCKOUT_COINS.Util
local BasePickup = KNOCKOUT_COINS.Class.BasePickup
local PickupSpeech = KNOCKOUT_COINS.Class.PickupSpeech

-- -------------------------------------------------------------------------- --
-- CoinPickup Class                                                           --
-- -------------------------------------------------------------------------- --

---@class CoinPickup : BasePickup
---@field type 'coin'
---@field radius number
---@field entity ObjectEntity
---@field coin Coin
---@field bobAmplitude number
---@field bobFrequency number
---@field rotationDirection -1|1
---@field rotationSpeed number
---@field randomOffset number
---@field lifetime number # set as fixed `number`, non/never `nil`
local CoinPickup = setmetatable({}, { __index = BasePickup })
CoinPickup.__index = CoinPickup

-- -------------------------------------------------------------------------- --
-- Constructor                                                                --
-- -------------------------------------------------------------------------- --

---@param entity ObjectEntity
---@param coin Coin
---@param ped integer
---@return CoinPickup
function CoinPickup.new(entity, coin, ped)
  local config = KNOCKOUT_COINS.GetSingleton():GetConfig()
  local radius = config:Get('PickupRadius', Default.PickupRadius) --[[@as number]]

  local instance = BasePickup.new(entity, radius, nil, ped)
  instance = setmetatable(instance, CoinPickup) --[[@as CoinPickup]]

  instance.coin = coin
  instance.radius = radius
  instance.type = 'coin'
  instance:SetEntity(entity)
  instance:SetPed(ped)

  local amplitude = config:Get('BobAmplitude', Default.BobAmplitude) --[[@as number]]
  local frequency = config:Get('BobFrequency', Default.BobFrequency) --[[@as number]]
  local rotationSpeed = config:Get('RotationSpeed', Default.RotationSpeed) --[[@as number]]
  local useBobSync = config:Get('BobSync', Default.BobSync) --[[@as boolean]]
  local useRandomDirection =
    config:Get('RandomRotationDirection', Default.RandomRotationDirection) --[[@as boolean]]

  instance.bobAmplitude = amplitude * 0.01
  instance.bobFrequency = frequency
  instance.randomOffset = useBobSync and 0 or (math.random() * math.pi * 2)
  instance.rotationSpeed = rotationSpeed
  instance.rotationDirection = useRandomDirection
      and (math.random(2) == 1 and -1 or 1)
    or 1

  local lifetimeMode = config:Get('LifetimeMode', Default.LifetimeMode) --[[@as Pickup_LifetimeModeEnum]] -- 2: hybrid
  local lifetime = config:Get('LifetimeSeconds', Default.LifetimeSeconds) --[[@as number]]

  instance:SetLifetimeMode(lifetimeMode)
  instance.lifetime = lifetime * 1000

  return instance
end

-- -------------------------------------------------------------------------- --
-- Methods                                                                    --
-- -------------------------------------------------------------------------- --

---@param currentTime number
function CoinPickup:Update(currentTime)
  self:UpdateAnimation(currentTime)
end

---@return number
function CoinPickup:GetRadius()
  return self.radius
end

---@return number x, number y, number z
function CoinPickup:GetPosition()
  return self.entity:GetPosition()
end

function CoinPickup:UpdateAnimation(currentTime)
  local _, _, z = self.entity:GetPosition()
  local seconds = currentTime / 1000

  local offset = 0
  if self.bobFrequency ~= 0 and self.bobAmplitude > 0 then
    offset = math.sin(seconds * self.bobFrequency + self.randomOffset)
      * self.bobAmplitude
  end
  self.entity:SetPosition(nil, nil, z + offset):SetRotation(
    Util.Modulus(seconds * self.rotationSpeed * self.rotationDirection, 360)
  )
end

---Pickup logic
function CoinPickup:OnPickup()
  self:SetCollected(true)
  PlayerAddMoney(self.coin:GetValue())
  SoundPlay2D('Cash_Pickup')
  PickupSpeech.PlayMoney()
end

---Overwrite base method
---@return number
function CoinPickup:GetLifetime()
  return self.lifetime
end

---Overwrite base method
---@return integer
function CoinPickup:GetPed()
  return self.ped
end

---@return Coin
function CoinPickup:GetCoin()
  return self.coin
end

-- -------------------------------------------------------------------------- --
-- Export                                                                     --
-- -------------------------------------------------------------------------- --

KNOCKOUT_COINS.Class.CoinPickup = CoinPickup

-- -------------------------------------------------------------------------- --
-- File: core/objects/pickup/PickupManager.lua
-- -------------------------------------------------------------------------- --
-- -------------------------------------------------------------------------- --
-- Import                                                                     --
-- -------------------------------------------------------------------------- --

local Event = KNOCKOUT_COINS.Enum.Event
local Util = KNOCKOUT_COINS.Util

-- -------------------------------------------------------------------------- --
-- PickupManager Class                                                        --
-- -------------------------------------------------------------------------- --

---@class PickupManager
---@field private _eventManager EventManager
---@field pickups table<PickupManager_ID, PickupManager_Pickup>
local PickupManager = {}
PickupManager.__index = PickupManager

local nextId = 1

-- -------------------------------------------------------------------------- --
-- Constructor                                                                --
-- -------------------------------------------------------------------------- --

---@param eventManager EventManager
---@return PickupManager
function PickupManager.new(eventManager)
  local instance = setmetatable({}, PickupManager)
  instance._eventManager = eventManager
  instance.pickups = {}
  return instance
end

-- -------------------------------------------------------------------------- --
-- Methods                                                                    --
-- -------------------------------------------------------------------------- --

---@param pickup BasePickup|CoinPickup
function PickupManager:Register(pickup)
  self.pickups[nextId] = pickup
  nextId = nextId + 1
end

---@param id PickupManager_ID
---@param reason? string # for event
---@return boolean success
function PickupManager:Remove(id, reason)
  local pickup = self.pickups[id]
  if not pickup then return false end
  pickup:Destroy()
  self.pickups[id] = nil

  self._eventManager:Emit(Event.CoinRemoved, pickup, reason)

  if Util.GetGameEdition() == 'PS2' then collectgarbage() end

  return true
end

function PickupManager:RemoveAll()
  for id, pickup in pairs(self.pickups) do
    pickup:Destroy()
    self.pickups[id] = nil
  end
  self._eventManager:Emit(Event.AllCoinsCleared)
end

function PickupManager:Update()
  local now = GetTimer()
  local currentArea = AreaGetVisible()

  self._eventManager:Emit(Event.BeforeCoinUpdateAll)

  for id, _ in pairs(self.pickups) do
    self._eventManager:Emit(Event.BeforeCoinUpdate)

    self:UpdatePickup(id, now, currentArea)

    self._eventManager:Emit(Event.AfterCoinUpdate)
  end

  self._eventManager:Emit(Event.AfterCoinUpdateAll)
end

---@param id integer
---@param now number
---@param currentArea integer
function PickupManager:UpdatePickup(id, now, currentArea)
  local pickup = self.pickups[id]
  if not pickup then return end

  if pickup:IsCollected() then return end

  local MAX_UPDATE_DISTANCE = 50

  local px, py, pz = PlayerGetPosXYZ()
  local x, y, z = pickup:GetPosition()
  local distance = DistanceBetweenCoords3d(px, py, pz + 0.5, x, y, z)

  -- pickup collection logic
  if distance <= pickup:GetRadius() then
    pickup:OnPickup()

    if pickup:GetType() == 'coin' then
      local coin = (pickup --[[@as CoinPickup]]):GetCoin()
      local value = coin:GetValue()
      self._eventManager:Emit(Event.CoinCollected, pickup, coin, value)
    end

    return self:Remove(id, 'collected')
  end

  -- animation update logic (optimized)
  if pickup:GetEntity():GetArea() == currentArea then
    if Util.GetGameEdition() == 'SE' then
      local cx, cy, cz = CameraGetXYZ()
      distance = DistanceBetweenCoords3d(cx, cy, cz, x, y, z)
    else
      distance = DistanceBetweenCoords3d(px, py, pz, x, y, z)
    end

    if distance <= MAX_UPDATE_DISTANCE then
      pickup:Update(pickup:GetType() == 'coin' and now or nil)
    end
  end

  -- lifetime management logic
  if pickup:GetLifetimeMode() == 0 then -- time-based
    if pickup:GetAge() >= pickup:GetLifetime() then
      self._eventManager:Emit(Event.CoinExpired, pickup, pickup:GetAge())
      self:Remove(id, 'expired')
    end
    --
  elseif pickup:GetLifetimeMode() == 1 then -- ped-based
    if not PedIsValid(pickup:GetPed()) then self:Remove(id, 'invalidPed') end
    --
  elseif pickup:GetLifetimeMode() == 2 then -- hybrid
    local koTime = pickup:GetKOTime()
    if koTime and now - koTime >= pickup:GetLifetime() then
      self._eventManager:Emit(Event.CoinExpired, pickup, pickup:GetAge())
      self:Remove(id, 'expired')
    elseif not PedIsValid(pickup:GetPed()) and not koTime then
      pickup:SetKOTime(now)
    end
  end
end

---@return integer
function PickupManager:GetAllPickupsCount()
  local count = 0
  for _, _ in pairs(self.pickups) do
    count = count + 1
  end
  return count
end

-- -------------------------------------------------------------------------- --
-- Export                                                                     --
-- -------------------------------------------------------------------------- --

KNOCKOUT_COINS.Class.PickupManager = PickupManager

-- -------------------------------------------------------------------------- --
-- Types                                                                      --
-- -------------------------------------------------------------------------- --

---@alias PickupManager_ID integer
---@alias PickupManager_Pickup BasePickup|CoinPickup

-- -------------------------------------------------------------------------- --
-- File: core/coins/Coin.lua
-- -------------------------------------------------------------------------- --
-- -------------------------------------------------------------------------- --
-- Coin Class                                                                 --
-- -------------------------------------------------------------------------- --

---@class Coin
---@field value integer # in cents
---@field model Coin_ModelName
local Coin = {}
Coin.__index = Coin

-- -------------------------------------------------------------------------- --
-- Constructor                                                                --
-- -------------------------------------------------------------------------- --

---@param model? Coin_ModelName
---@param value? integer
---@return Coin
function Coin.new(model, value)
  local instance = setmetatable({}, Coin)
  instance.model = model or 'coin_penny'
  instance.value = value or 25
  return instance
end

-- -------------------------------------------------------------------------- --
-- Methods                                                                    --
-- -------------------------------------------------------------------------- --

---@return integer
function Coin:GetValue()
  return self.value
end

---@return Coin_ModelName
function Coin:GetModel()
  return self.model
end

-- -------------------------------------------------------------------------- --
-- Export                                                                     --
-- -------------------------------------------------------------------------- --

KNOCKOUT_COINS.Class.Coin = Coin

-- -------------------------------------------------------------------------- --
-- Types                                                                      --
-- -------------------------------------------------------------------------- --

---@alias Coin_ModelName 'coin_penny'|'coin_dollar'

-- -------------------------------------------------------------------------- --
-- File: core/coins/CoinDropManager.lua
-- -------------------------------------------------------------------------- --
-- -------------------------------------------------------------------------- --
-- Import                                                                     --
-- -------------------------------------------------------------------------- --

local Default = KNOCKOUT_COINS.DefaultSettings
local Util = KNOCKOUT_COINS.Util

-- -------------------------------------------------------------------------- --
-- CoinDropManager Class                                                      --
-- -------------------------------------------------------------------------- --

---@class CoinDropManager
local CoinDropManager = {}

-- -------------------------------------------------------------------------- --
-- Static Methods                                                             --
-- -------------------------------------------------------------------------- --

---@param factionId integer
---@return integer count
function CoinDropManager.GetDropCountForFaction(factionId)
  local config = KNOCKOUT_COINS.GetSingleton():GetConfig()

  local name = Util.GetFactionName(factionId)
  local minKey = name .. 'Min'
  local maxKey = name .. 'Max'

  local minVal = config:Get(minKey, Default[minKey] or 1) --[[@as number]]
  local maxVal = config:Get(maxKey, Default[maxKey] or 2) --[[@as number]]

  if maxVal < minVal then maxVal = minVal end
  return math.random(minVal, maxVal)
end

---@return boolean
function CoinDropManager.ShouldDropCoin()
  local config = KNOCKOUT_COINS.GetSingleton():GetConfig()
  local globalChance = config:Get('GlobalDropChance', 75) --[[@as number]]
  return Util.PercentChance(globalChance)
end

---@return Coin_ModelName
function CoinDropManager.GetCoinType()
  local config = KNOCKOUT_COINS.GetSingleton():GetConfig()
  local pennyChance = config:Get('CoinPennyChance', Default.CoinPennyChance) --[[@as number]]
  local dollarChance = config:Get('CoinDollarChance', Default.CoinDollarChance) --[[@as number]]

  local roll = math.random(0, 100)
  if roll < pennyChance then
    return 'coin_penny'
  elseif roll < pennyChance + dollarChance then
    return 'coin_dollar'
  end
  return 'coin_penny'
end

-- -------------------------------------------------------------------------- --
-- Export                                                                     --
-- -------------------------------------------------------------------------- --

KNOCKOUT_COINS.Class.CoinDropManager = CoinDropManager

-- -------------------------------------------------------------------------- --
-- File: core/threads/PedKnockedOut.lua
-- -------------------------------------------------------------------------- --
local KC = _G.KNOCKOUT_COINS
local Util = KC.Util

-- -------------------------------------------------------------------------- --
-- PedKnockedOut thread                                                       --
-- -------------------------------------------------------------------------- --
-- The function name MUST not be too long < 30 characters or it'll crash.

---@param eventManager? EventManager
function KC__PedKnockedOut(eventManager)
  KC__PedKnockedOut = nil --[[@diagnostic disable-line]]

  while not SystemIsReady() or AreaIsLoading() do
    Wait(0)
  end

  local gameEdition = Util.GetGameEdition()

  do
    local extraWaitTime = ({ ['SE'] = 500, ['AE'] = 3000, ['PS2'] = 3000 })[gameEdition]
    Wait(extraWaitTime or 3000)

    -- Bully AE: Wait for warning message
    if gameEdition == 'AE' and not KC.AE_isConfigLoaded then
      while KC.AE_isWarningMessageDisplayed do
        Wait(0)
      end
      Wait(1000)
    end
  end

  eventManager = eventManager or KC.GetSingleton():GetEventManager()

  local allPeds = gameEdition ~= 'SE' and Util.AllPeds or AllPeds
  local deadPeds = {}
  local waitTime = gameEdition == 'PS2' and 500 or 0

  gameEdition = nil --[[@diagnostic disable-line]]

  while true do
    Wait(waitTime) -- prevent PS2 thread overload

    for ped in allPeds() do
      if ped ~= gPlayer then
        if PedIsDead(ped) and not deadPeds[ped] then
          deadPeds[ped] = true
          eventManager:Emit('PedKnockedOut', ped)
        elseif not PedIsDead(ped) and deadPeds[ped] then
          deadPeds[ped] = nil -- revive/reset case
        end
      end
    end
  end
end

-- -------------------------------------------------------------------------- --
-- Export                                                                     --
-- -------------------------------------------------------------------------- --

KC.Thread.PedKnockedOut = KC__PedKnockedOut

-- -------------------------------------------------------------------------- --
-- Create the thread                                                          --
-- -------------------------------------------------------------------------- --

function KnockoutCoins_CreateThread()
  if KC.Util.GetGameEdition() ~= 'SE' then
    KC.Thread.PedKnockedOut_thread =
      CreateThread('KC__PedKnockedOut', KC.GetSingleton():GetEventManager())
  end
  KnockoutCoins_CreateThread = nil --[[@diagnostic disable-line]]
end

-- -------------------------------------------------------------------------- --
-- File: core/threads/ThreadManager.lua
-- -------------------------------------------------------------------------- --
-- -------------------------------------------------------------------------- --
-- ThreadManager Class                                                        --
-- -------------------------------------------------------------------------- --

---@class ThreadManager
---@field private _threads table<string, { thread: thread, func: function }>
local ThreadManager = {}
ThreadManager.__index = ThreadManager

-- -------------------------------------------------------------------------- --
-- Constructor                                                                --
-- -------------------------------------------------------------------------- --

---@return ThreadManager
function ThreadManager.new()
  local instance = {}

  -- private attributes

  instance._threads = {}

  instance = setmetatable(instance, ThreadManager)

  -- public attributes
  -- ...

  return instance
end

-- -------------------------------------------------------------------------- --
-- Methods                                                                    --
-- -------------------------------------------------------------------------- --

---@param name string
---@param func function
---@param thread? thread # Already created thread
---@param ... any
function ThreadManager:Create(name, func, thread, ...)
  if self._threads[name] then return print('Thread already exists') end

  local l_thread = (KNOCKOUT_COINS.Util.GetGameEdition() ~= 'SE' and thread)
      and thread
    or CreateThread(func, unpack(arg))

  self._threads[name] = { thread = l_thread, func = func }
end

---@param name string
---@return boolean success
function ThreadManager:Stop(name)
  local entry = self._threads[name]
  if not entry then return false end
  TerminateThread(entry.thread)
  self._threads[name] = nil
  return true
end

function ThreadManager:StopAll()
  for _, entry in pairs(self._threads) do
    TerminateThread(entry.thread)
  end
  self._threads = {}
end

---@param name string
---@return ThreadManager_Entry
function ThreadManager:GetThreadEntry(name)
  return self._threads[name]
end

---@return string[]
function ThreadManager:GetThreadNameList()
  local list = {}
  for name, _ in pairs(self._threads) do
    table.insert(list, name)
  end

  table.sort(list, function(a, b)
    return a < b -- sort names by ascending
  end)

  return list
end

-- -------------------------------------------------------------------------- --
-- Export                                                                     --
-- -------------------------------------------------------------------------- --

KNOCKOUT_COINS.Class.ThreadManager = ThreadManager

-- -------------------------------------------------------------------------- --
-- Types                                                                      --
-- -------------------------------------------------------------------------- --

---@alias ThreadManager_Entry { thread: thread, func: function }

-- -------------------------------------------------------------------------- --
-- File: core/EventManager.lua
-- -------------------------------------------------------------------------- --
local isBullySE = KNOCKOUT_COINS.Util.GetGameEdition() == 'SE'

-- -------------------------------------------------------------------------- --
-- EventManager Class                                                         --
-- -------------------------------------------------------------------------- --

---@class EventManager
---@field private _prefix 'KnockoutCoins:'
---@field private _events table<string, EventManager_EventEntry[]>
local EventManager = {}
EventManager.__index = EventManager

-- -------------------------------------------------------------------------- --
-- Constructor                                                                --
-- -------------------------------------------------------------------------- --

---@return EventManager
function EventManager.new()
  local instance = {}

  -- Private attributes

  instance._prefix = 'KnockoutCoins:'
  instance._events = {}

  instance = setmetatable(instance, EventManager)

  -- Public attributes

  -- ...

  return instance
end

-- -------------------------------------------------------------------------- --
-- Methods                                                                    --
-- -------------------------------------------------------------------------- --

---@param eventName string
---@param callback function
function EventManager:AddListener(eventName, callback)
  if not self._events[eventName] then self._events[eventName] = {} end

  local entry
  if isBullySE then
    entry = {
      handler = RegisterLocalEventHandler(self._prefix .. eventName, callback),
      callback = callback,
    }
  else
    entry = { handler = nil, callback = callback }
  end

  table.insert(self._events[eventName], entry)
end

---@param eventName string
---@param callback? function
---@param handler? userdata
---@return boolean success
function EventManager:RemoveListener(eventName, callback, handler)
  if not self._events[eventName] then return false end
  if not callback and not handler then return false end

  for index, entry in ipairs(self._events[eventName]) do
    if entry.callback == callback or entry.handler == handler then
      if isBullySE then RemoveEventHandler(entry.handler) end
      table.remove(self._events[eventName], index)
      return true
    end
  end

  return false
end

---@param eventName string
---@param ... any
function EventManager:Emit(eventName, ...)
  if not self._events[eventName] then return end
  if isBullySE then
    RunLocalEvent(self._prefix .. eventName, unpack(arg))
  else
    for _, entry in ipairs(self._events[eventName]) do
      entry.callback(unpack(arg))
    end
  end
end

-- -------------------------------------------------------------------------- --
-- Export                                                                     --
-- -------------------------------------------------------------------------- --

KNOCKOUT_COINS.Class.EventManager = EventManager

-- -------------------------------------------------------------------------- --
-- Types                                                                      --
-- -------------------------------------------------------------------------- --

---@alias EventManager_EventEntry { handler: userdata, callback: function }

-- -------------------------------------------------------------------------- --
-- File: core/KnockoutCoins.lua
-- -------------------------------------------------------------------------- --
-- -------------------------------------------------------------------------- --
-- Import                                                                     --
-- -------------------------------------------------------------------------- --

local Event = KNOCKOUT_COINS.Enum.Event
local Default = KNOCKOUT_COINS.DefaultSettings
local Util = KNOCKOUT_COINS.Util
local Thread = KNOCKOUT_COINS.Thread

local Coin = KNOCKOUT_COINS.Class.Coin
local CoinDropManager = KNOCKOUT_COINS.Class.CoinDropManager
local CoinPickup = KNOCKOUT_COINS.Class.CoinPickup
local Config = KNOCKOUT_COINS.Class.Config
local EventManager = KNOCKOUT_COINS.Class.EventManager
local IniSource = KNOCKOUT_COINS.Class.IniSource
local LuaSource = KNOCKOUT_COINS.Class.LuaSource
local ObjectEntity = KNOCKOUT_COINS.Class.ObjectEntity
local PickupManager = KNOCKOUT_COINS.Class.PickupManager
local ThreadManager = KNOCKOUT_COINS.Class.ThreadManager

-- -------------------------------------------------------------------------- --
-- KnockoutCoins Class                                                        --
-- -------------------------------------------------------------------------- --

---@class KnockoutCoins
---@field config Config
---@field eventManager EventManager
---@field pickupManager PickupManager
---@field threadManager ThreadManager
---@field spawnCoinLogic function
local KnockoutCoins = {}
KnockoutCoins.__index = KnockoutCoins

-- -------------------------------------------------------------------------- --
-- Constructor                                                                --
-- -------------------------------------------------------------------------- --

---@return KnockoutCoins
function KnockoutCoins.new()
  local instance = setmetatable({}, KnockoutCoins)

  local configData = KNOCKOUT_COINS.ConfigData
  local configSource

  if Util.GetGameEdition() == 'SE' then
    configSource = IniSource.new(configData.SE.path, configData.SE.file)
  else
    configSource = LuaSource.new(
      configData.AE.path,
      configData.AE.file,
      KNOCKOUT_COINS.Config or KNOCKOUT_COINS.DefaultSettings -- user config or default config
    )
  end

  instance.config = Config.new(KNOCKOUT_COINS.DefaultSettings, configSource)

  instance.eventManager = EventManager.new()
  instance.pickupManager = PickupManager.new(instance.eventManager)
  instance.threadManager = ThreadManager.new()

  return instance
end

-- -------------------------------------------------------------------------- --
-- Methods                                                                    --
-- -------------------------------------------------------------------------- --

function KnockoutCoins:Init()
  ---@param ped integer
  function self.spawnCoinLogic(ped)
    local shouldDrop = Util.IsPedHumanoid(ped)
      and CoinDropManager.ShouldDropCoin()

    if not shouldDrop then
      return self.eventManager:Emit(Event.CoinDropFailed, ped)
    end

    local fx, fy, fz = PedGetPosXYZ(ped) -- feet
    local hx, hy, hz = PedGetHeadPos(ped) -- head
    local cx, cy, cz = Util.LerpBetweenCoords3d(fx, fy, fz, hx, hy, hz, 0.5)
    local zOffset = 0.5

    local factionId = PedGetFaction(ped)
    local numCoins = CoinDropManager.GetDropCountForFaction(factionId)
    local maxScatterDistance = 1

    for _ = 1, numCoins do
      local coinType = CoinDropManager.GetCoinType()
      local key = coinType == 'coin_penny' and 'CoinPenny' or 'CoinDollar'
      local fallbackValue = Default[key]
        or (math.random(2) == 1 and 'CoinPenny' or 'CoinDollar')

      local dx = ((math.random() - 0.5) * 2) * maxScatterDistance
      local dy = ((math.random() - 0.5) * 2) * maxScatterDistance

      local value = self.config:Get(key, fallbackValue) --[[@as number]]
      local coin = Coin.new(coinType, value)
      local object = ObjectEntity.new(coinType, cx + dx, cy + dy, cz + zOffset)
      local coinPickup = CoinPickup.new(object, coin, ped)
      self.pickupManager:Register(coinPickup)

      self.eventManager:Emit(Event.CoinSpawned, coinPickup, ped)
    end

    self.eventManager:Emit(Event.CoinBatchSpawned, ped, numCoins)
  end

  self.eventManager:AddListener('PedKnockedOut', self.spawnCoinLogic)

  local thread = Util.GetGameEdition() ~= 'SE'
      and KNOCKOUT_COINS.Thread.PedKnockedOut_thread
    or nil

  self.threadManager:Create(
    'PedKnockedOut',
    Thread.PedKnockedOut,
    thread,
    self.eventManager
  )
end

function KnockoutCoins:Update()
  self.pickupManager:Update()
end

function KnockoutCoins:Cleanup()
  self.pickupManager:RemoveAll()
  self.eventManager:RemoveListener('PedKnockedOut', self.spawnCoinLogic, nil)
  self.threadManager:StopAll()
end

-- -------------------------------------------------------------------------- --
-- Getting instance                                                           --
-- -------------------------------------------------------------------------- --

---@return Config
function KnockoutCoins:GetConfig()
  return self.config
end

---@return EventManager
function KnockoutCoins:GetEventManager()
  return self.eventManager
end

-- -------------------------------------------------------------------------- --
-- Export                                                                     --
-- -------------------------------------------------------------------------- --

KNOCKOUT_COINS.Class.KnockoutCoins = KnockoutCoins

-- -------------------------------------------------------------------------- --
-- File: setup.lua
-- -------------------------------------------------------------------------- --
-- -------------------------------------------------------------------------- --
-- Import                                                                     --
-- -------------------------------------------------------------------------- --

local KC = KNOCKOUT_COINS -- shorten
local KnockoutCoins = KC.Class.KnockoutCoins

-- -------------------------------------------------------------------------- --
-- Setup                                                                      --
-- -------------------------------------------------------------------------- --

---@return KnockoutCoins
function KNOCKOUT_COINS.GetSingleton()
  if not KC.Instance.knockoutCoins then
    KC.Instance.knockoutCoins = KnockoutCoins.new()
  end
  return KC.Instance.knockoutCoins
end

-- -------------------------------------------------------------------------- --
-- File: API.lua
-- -------------------------------------------------------------------------- --
-- -------------------------------------------------------------------------- --
-- Knockout Coins API                                                         --
-- -------------------------------------------------------------------------- --

local API = KNOCKOUT_COINS.API

-- -------------------------------------------------------------------------- --
-- Getting Instance                                                           --
-- -------------------------------------------------------------------------- --

---@return KnockoutCoins
function API.GetSingleton()
  return _G.KNOCKOUT_COINS.GetSingleton()
end

---@return EventManager
function API.GetEventManager()
  return API.GetEventManager()
end

-- TODO: Add more...

---@return integer
function API.GetSpawnedCoinCount()
  return API.GetSingleton().pickupManager:GetAllPickupsCount()
end

-- -------------------------------------------------------------------------- --
-- File: main.lua
-- -------------------------------------------------------------------------- --
local isBullyAE = type(_G.PlayerGetUsingTouchScreen) == 'function'
local isBullySE = not isBullyAE and type(_G.ClassMusicSetPlayers) == 'function'
local isBullyPS2 = not isBullyAE and not isBullySE

-- -------------------------------------------------------------------------- --
-- Setup                                                                      --
-- -------------------------------------------------------------------------- --

if isBullySE then
  function MissionSetup()
    while not SystemIsReady() or AreaIsLoading() do
      Wait(0)
    end

    LoadScript('init.lua')
    LoadScript('setup.lua')
    LoadScript('API.lua')
  end
end

-- -------------------------------------------------------------------------- --
-- Entry Point                                                                --
-- -------------------------------------------------------------------------- --

(function()
  function KnockoutCoins_main()
    KnockoutCoins_main = nil --[[@diagnostic disable-line]]

    while not isBullySE and (not SystemIsReady() or AreaIsLoading()) do
      Wait(0)
    end

    local mod = KNOCKOUT_COINS.GetSingleton()
    if KnockoutCoins_CreateThread then KnockoutCoins_CreateThread() end
    mod:Init()

    if isBullyPS2 then collectgarbage() end

    while true do
      Wait(0)
      mod:Update()
    end

    if not isBullySE then mod:Cleanup() end
  end

  CreateThread('KnockoutCoins_main')
end)()

-- -------------------------------------------------------------------------- --
-- Cleanup                                                                    --
-- -------------------------------------------------------------------------- --

if isBullySE then
  function MissionCleanup()
    KNOCKOUT_COINS.GetSingleton():Cleanup()
  end
end

-- -------------------------------------------------------------------------- --
-- Credit                                                                     --
-- -------------------------------------------------------------------------- --

function KnockoutCoins_Credit()
  print([[
    Knockout Coins
    Mod by: RBS ID

    GitHub: github.com/RanggaBS
    YouTube: youtube.com/@rbsid
  ]])
end
